<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABNOGUARD | AI Surveillance</title>
    <style>
        :root {
            --bg: #0d1117;
            --panel: #161b22;
            --card: #21262d;
            --border: #30363d;
            --text: #c9d1d9;
            --dim: #8b949e;
            --accent: #58a6ff;
            --success: #3fb950;
            --warning: #d29922;
            --danger: #f85149;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: -apple-system, sans-serif;
            min-height: 100vh;
        }

        nav {
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            height: 56px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .brand {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--accent);
            margin-right: 40px;
        }

        .nav-links {
            display: flex;
            gap: 5px;
            flex: 1;
        }

        .nav-link {
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            color: var(--dim);
            text-decoration: none;
            font-size: 0.9em;
        }

        .nav-link:hover {
            background: var(--card);
            color: var(--text);
        }

        .nav-link.active {
            background: var(--accent);
            color: white;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--dim);
        }

        .status-dot.active {
            background: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: 0.5
            }
        }

        .page {
            display: none;
            padding: 20px;
        }

        .page.active {
            display: block;
        }

        /* Upload Section */
        .upload-box {
            background: var(--panel);
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            max-width: 600px;
            margin: 0 auto 30px;
        }

        .upload-box.dragover {
            border-color: var(--accent);
            background: rgba(88, 166, 255, 0.1);
        }

        .upload-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .upload-title {
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .upload-desc {
            color: var(--dim);
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            padding: 12px 30px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
        }

        .upload-btn:hover {
            opacity: 0.9;
        }

        .selected-file {
            margin-top: 15px;
            padding: 10px;
            background: var(--card);
            border-radius: 6px;
            display: none;
        }

        .selected-file.show {
            display: block;
        }

        .file-name {
            font-weight: 600;
            color: var(--success);
        }

        .start-btn {
            margin-top: 15px;
            padding: 12px 40px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            display: none;
        }

        .start-btn.show {
            display: inline-block;
        }

        .stop-btn {
            padding: 8px 20px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 10px;
        }

        /* Video Grid */
        .live-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            margin-top: 20px;
        }

        .video-container {
            background: var(--panel);
            border-radius: 8px;
            overflow: hidden;
        }

        .video-header {
            padding: 12px 16px;
            background: var(--card);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #live-feed {
            width: 100%;
            height: 400px;
            object-fit: contain;
            background: #000;
        }

        .metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            background: var(--card);
        }

        .metric {
            padding: 12px;
            text-align: center;
            border-right: 1px solid var(--border);
        }

        .metric:last-child {
            border-right: none;
        }

        .metric-val {
            font-size: 1.4em;
            font-weight: 700;
            font-family: monospace;
        }

        .metric-lbl {
            font-size: 0.7em;
            color: var(--dim);
            text-transform: uppercase;
        }

        .analysis-panel {
            background: var(--panel);
            border-radius: 8px;
        }

        .analysis-header {
            padding: 12px 16px;
            background: var(--card);
            border-bottom: 1px solid var(--border);
            font-weight: 600;
        }

        .analysis-body {
            padding: 16px;
            height: 450px;
            overflow-y: auto;
        }

        .frame-info {
            font-family: monospace;
            font-size: 0.85em;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        /* Screenshots/Briefings */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .card {
            background: var(--panel);
            border-radius: 8px;
            overflow: hidden;
        }

        .card img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            cursor: pointer;
        }

        .card-body {
            padding: 12px;
        }

        .card-time {
            font-size: 0.8em;
            color: var(--dim);
        }

        .card-reason {
            font-size: 0.9em;
            margin-top: 4px;
        }

        .auto-badge {
            background: var(--warning);
            color: black;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7em;
        }

        .briefing-card {
            background: var(--panel);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
            border-left: 4px solid var(--warning);
        }

        .briefing-card.high {
            border-left-color: var(--danger);
        }

        .briefing-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .briefing-title {
            font-size: 1.1em;
            font-weight: 600;
        }

        .briefing-time {
            color: var(--dim);
            font-size: 0.85em;
        }

        .briefing-content {
            line-height: 1.6;
            color: var(--dim);
        }

        .briefing-content strong {
            color: var(--text);
        }

        .empty-state {
            text-align: center;
            padding: 60px;
            color: var(--dim);
        }

        .empty-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
    </style>
</head>

<body>
    <nav>
        <div class="brand">üõ°Ô∏è ABNOGUARD</div>
        <div class="nav-links">
            <a class="nav-link active" data-page="live">üìπ Live Analysis</a>
            <a class="nav-link" data-page="screenshots">üì∏ Screenshots</a>
            <a class="nav-link" data-page="briefings">üìã Briefings</a>
        </div>
        <div class="status">
            <span class="status-dot" id="status-dot"></span>
            <span id="status-text">Waiting for video</span>
        </div>
    </nav>

    <!-- PAGE 1: LIVE ANALYSIS -->
    <div class="page active" id="page-live">
        <div class="upload-box" id="upload-box">
            <div class="upload-icon">üìÅ</div>
            <div class="upload-title">Upload Your Video</div>
            <div class="upload-desc">Drag & drop a video file here, or click to browse</div>
            <input type="file" id="file-input" class="file-input" accept=".mp4,.avi,.mov,.mkv,.wmv">
            <button class="upload-btn" onclick="document.getElementById('file-input').click()">Select Video
                File</button>
            <div class="selected-file" id="selected-file">
                <span>Selected: </span><span class="file-name" id="file-name"></span>
            </div>
            <button class="start-btn" id="start-btn">‚ñ∂ Start Analysis</button>
        </div>

        <div class="live-grid" id="live-grid" style="display: none;">
            <div class="video-container">
                <div class="video-header">
                    <span>Live Video Feed</span>
                    <div>
                        <span id="fps-badge">0 FPS</span>
                        <button class="stop-btn" id="stop-btn">‚èπ Stop</button>
                    </div>
                </div>
                <img id="live-feed" src="/video_feed" alt="Video">
                <div class="metrics">
                    <div class="metric">
                        <div class="metric-val" id="m-tracks">0</div>
                        <div class="metric-lbl">Tracks</div>
                    </div>
                    <div class="metric">
                        <div class="metric-val" id="m-anomaly">0.00</div>
                        <div class="metric-lbl">Anomaly</div>
                    </div>
                    <div class="metric">
                        <div class="metric-val" id="m-risk" style="color: var(--success)">LOW</div>
                        <div class="metric-lbl">Risk</div>
                    </div>
                    <div class="metric">
                        <div class="metric-val" id="m-fps">0</div>
                        <div class="metric-lbl">FPS</div>
                    </div>
                </div>
            </div>
            <div class="analysis-panel">
                <div class="analysis-header">üß† Frame-by-Frame Analysis</div>
                <div class="analysis-body">
                    <div class="frame-info" id="frame-analysis">Waiting for video processing...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- PAGE 2: SCREENSHOTS -->
    <div class="page" id="page-screenshots">
        <h2 style="margin-bottom: 20px;">üì∏ Auto-Captured Screenshots</h2>
        <p style="color: var(--dim); margin-bottom: 20px;">Screenshots are automatically captured when anomalies are
            detected.</p>
        <div class="grid" id="screenshots-grid"></div>
    </div>

    <!-- PAGE 3: BRIEFINGS -->
    <div class="page" id="page-briefings">
        <h2 style="margin-bottom: 20px;">üìã Incident Briefings</h2>
        <p style="color: var(--dim); margin-bottom: 20px;">Detailed explanations of detected incidents.</p>
        <div id="briefings-list"></div>
    </div>

    <script>
        let selectedFile = null;

        // Navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.onclick = () => {
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                link.classList.add('active');
                document.getElementById('page-' + link.dataset.page).classList.add('active');
                if (link.dataset.page === 'screenshots') loadScreenshots();
                if (link.dataset.page === 'briefings') loadBriefings();
            };
        });

        // Drag & Drop
        const uploadBox = document.getElementById('upload-box');
        uploadBox.ondragover = (e) => { e.preventDefault(); uploadBox.classList.add('dragover'); };
        uploadBox.ondragleave = () => uploadBox.classList.remove('dragover');
        uploadBox.ondrop = (e) => {
            e.preventDefault();
            uploadBox.classList.remove('dragover');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        };

        // File Selection
        document.getElementById('file-input').onchange = (e) => {
            if (e.target.files.length) handleFile(e.target.files[0]);
        };

        function handleFile(file) {
            selectedFile = file;
            document.getElementById('file-name').textContent = file.name;
            document.getElementById('selected-file').classList.add('show');
            document.getElementById('start-btn').classList.add('show');
        }

        // Start Analysis
        document.getElementById('start-btn').onclick = async () => {
            if (!selectedFile) return;

            const formData = new FormData();
            formData.append('file', selectedFile);

            document.getElementById('status-text').textContent = 'Uploading...';

            try {
                const res = await fetch('/api/upload', { method: 'POST', body: formData });
                const data = await res.json();
                if (data.status === 'ok') {
                    document.getElementById('upload-box').style.display = 'none';
                    document.getElementById('live-grid').style.display = 'grid';
                    document.getElementById('live-feed').src = '/video_feed?' + Date.now();
                    document.getElementById('status-text').textContent = 'Processing';
                    document.getElementById('status-dot').classList.add('active');
                }
            } catch (e) {
                alert('Upload failed: ' + e.message);
            }
        };

        // Stop Analysis
        document.getElementById('stop-btn').onclick = async () => {
            await fetch('/api/stop', { method: 'POST' });
            document.getElementById('status-text').textContent = 'Stopped';
            document.getElementById('status-dot').classList.remove('active');
        };

        // WebSocket
        let ws;
        function connectWS() {
            ws = new WebSocket(`ws://${location.host}/ws/stream`);
            ws.onmessage = (e) => {
                const data = JSON.parse(e.data);
                if (data.type === 'stats') {
                    document.getElementById('fps-badge').innerText = data.fps + ' FPS';
                    document.getElementById('m-fps').innerText = data.fps;
                    document.getElementById('m-tracks').innerText = data.tracks;
                    document.getElementById('m-anomaly').innerText = data.anomaly.toFixed(2);

                    const riskEl = document.getElementById('m-risk');
                    if (data.risk > 0.7) { riskEl.innerText = 'HIGH'; riskEl.style.color = 'var(--danger)'; }
                    else if (data.risk > 0.4) { riskEl.innerText = 'MED'; riskEl.style.color = 'var(--warning)'; }
                    else { riskEl.innerText = 'LOW'; riskEl.style.color = 'var(--success)'; }

                    if (data.processing) {
                        document.getElementById('status-dot').classList.add('active');
                        document.getElementById('status-text').innerText = 'Processing';
                    }

                    if (data.situation) {
                        document.getElementById('frame-analysis').innerText = data.situation;
                    }
                }
            };
            ws.onclose = () => setTimeout(connectWS, 2000);
        }
        connectWS();

        // Load Screenshots
        async function loadScreenshots() {
            const res = await fetch('/api/screenshots');
            const shots = await res.json();
            const grid = document.getElementById('screenshots-grid');
            if (!shots.length) {
                grid.innerHTML = '<div class="empty-state"><div class="empty-icon">üì∑</div><div>No screenshots yet.<br>They will appear here when anomalies are detected.</div></div>';
                return;
            }
            grid.innerHTML = '';
            shots.forEach(s => {
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                    <img src="${s.url}" onclick="window.open('${s.url}', '_blank')">
                    <div class="card-body">
                        <span class="card-time">${s.time}</span>
                        <span class="auto-badge">AUTO</span>
                        <div class="card-reason">${s.reason}</div>
                    </div>
                `;
                grid.appendChild(div);
            });
        }

        // Load Briefings
        async function loadBriefings() {
            const res = await fetch('/api/briefings');
            const briefs = await res.json();
            const list = document.getElementById('briefings-list');
            if (!briefs.length) {
                list.innerHTML = '<div class="empty-state"><div class="empty-icon">üìã</div><div>No incident briefings yet.</div></div>';
                return;
            }
            list.innerHTML = '';
            briefs.forEach(b => {
                const div = document.createElement('div');
                div.className = `briefing-card ${b.level}`;
                div.innerHTML = `
                    <div class="briefing-header">
                        <span class="briefing-title">${b.title}</span>
                        <span class="briefing-time">${b.time}</span>
                    </div>
                    <div class="briefing-content">${b.content}</div>
                `;
                list.appendChild(div);
            });
        }
    </script>
</body>

</html>